package dk.aau.cs {	import flash.net.Socket;	import flash.system.Security;	import flash.utils.ByteArray;	import flash.events.*;	import flash.external.ExternalInterface;		public class ARDrone {				private var connection:Socket = new Socket();		private var ip:String;		private var port:int;		private var lastMessage:String = '';		private var key:String = 'lottehvorduhenne';		public function ARDrone(ip_address:String, port_number:int, newKey:String) {			ip = ip_address;			port = port_number;			key = newKey;			connection.connect(ip, port);			configureListeners();		}				public function disconnect():void {			connection.close();		}				private function configureListeners():void {			ExternalInterface.call("console.log", "setting up connectionhandlers");    		connection.addEventListener(Event.CLOSE, onClose);    		connection.addEventListener(Event.CONNECT, onConnect);    		connection.addEventListener(IOErrorEvent.IO_ERROR, onIoError);    		connection.addEventListener(SecurityErrorEvent.SECURITY_ERROR, onSecurityError);    		connection.addEventListener(ProgressEvent.SOCKET_DATA, onData);		}				private function onClose(event:Event):void {			ExternalInterface.call("console.log", "connection closed: "+ event);		}				private function onConnect(event:Event):void {			ExternalInterface.call("console.log", "connection open: "+ event);		}				private function onIoError(event:IOErrorEvent):void {			ExternalInterface.call("console.log", "ioError: "+ event);		}				private function onSecurityError(event:SecurityErrorEvent):void {			ExternalInterface.call("console.log", "securityError: "+ event);		}				private function onData(event:ProgressEvent):void {			ExternalInterface.call("console.log", "socketData: "+ event);		}				private function sendCommand(object:Object):String {			object.key = key;			var str:String = JSON.stringify(object);			if (connection.connected) {				connection.writeUTFBytes(str+'\n');				connection.flush();				ExternalInterface.call("console.log", "message sent");			} else {				connection.connect(ip, port);				ExternalInterface.call("console.log", "connection not open. Retrying to open connection");			}			return str;		}				public function idle():String {			var o:Object = new Object();			o.action = 'idle';			return sendCommand(o);		}				public function hover() {			//sendCommand('hover');		}				public function flight():String {			var o:Object = new Object();			o.action = 'flight';			return sendCommand(o);		}				public function left():String {			return pcmd(1, 0, 0, 0, -0.4);		}				public function right():String {			return pcmd(1, 0, 0, 0, 0.4);		}				public function forward():String {			return pcmd(1, 0, 0.4, 0, 0);		}				public function backward():String {			return pcmd(1, 0, -0.4, 0, 0);		}				private function pcmd(flag:int, phi:Number, theta:Number, gaz:Number, yaw:Number):String {			/*var axises:Array = [phi, theta, gaz, yaw];			axises = convertAxis(axises);			var values:Array = [flag];			values = values.concat(axises);			var args:String = values.toString();*/			var o:Object = new Object();			o.action = 'steer';			o.args = new Object();			o.args.flag = flag;			o.args.phi = phi;			o.args.theta = theta;			o.args.gaz = gaz;			o.args.yaw = yaw;			return sendCommand(o);		}				private function convertAxis(arg:Array) {			var i:int;			for (i = 0; i < arg.length; i++) {				arg[i] = minmax(-1.0, 1.0, arg[i]);				arg[i] = float2int(arg[i]);			}						return arg;		}				private function minmax(min:Number, max:Number, val:int) {			if (val < min) {				val = min;			} else if (val > max) {				val = max;			}						return val;		}				private function float2int(number:Number) {			var b:ByteArray = new ByteArray();			b.writeFloat(number);			b.position = 0;			var i:int = b.readInt();						return i;		}	}	}